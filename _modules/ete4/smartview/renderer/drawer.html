<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ete4.smartview.renderer.drawer &#8212; ETE Toolkit 4.0.0-beta2 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css?v=12dfc556" />
    <script src="../../../../_static/documentation_options.js?v=382e6e0c"></script>
    <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../../../../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../../../../about.html" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ete4.smartview.renderer.drawer</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Classes and functions for drawing a tree.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">atan2</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">deque</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>

<span class="kn">from</span> <span class="nn">ete4.core</span> <span class="kn">import</span> <span class="n">operations</span> <span class="k">as</span> <span class="n">ops</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">TreeStyle</span>
<span class="kn">from</span> <span class="nn">.face_positions</span> <span class="kn">import</span> <span class="n">FACE_POSITIONS</span><span class="p">,</span> <span class="n">make_faces</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">draw_helpers</span> <span class="k">as</span> <span class="n">dh</span>
<span class="n">Box</span> <span class="o">=</span> <span class="n">dh</span><span class="o">.</span><span class="n">Box</span>  <span class="c1"># shortcut, because we use it a lot</span>

<span class="n">Size</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Size&#39;</span><span class="p">,</span> <span class="s1">&#39;dx dy&#39;</span><span class="p">)</span>  <span class="c1"># size of a 2D shape (sizes are always &gt;= 0)</span>
<span class="n">TreeActive</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;TreeActive&#39;</span><span class="p">,</span> <span class="s1">&#39;nodes clades&#39;</span><span class="p">)</span>
<span class="n">Active</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Active&#39;</span><span class="p">,</span> <span class="s1">&#39;results parents&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="get_empty_active">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.get_empty_active">[docs]</a>
<span class="k">def</span> <span class="nf">get_empty_active</span><span class="p">():</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="n">Active</span><span class="p">(</span><span class="nb">set</span><span class="p">(),</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">clades</span> <span class="o">=</span> <span class="n">Active</span><span class="p">(</span><span class="nb">set</span><span class="p">(),</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">TreeActive</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">clades</span><span class="p">)</span></div>



<span class="c1"># The coordinates (x, y, dx, dy) are all &quot;generalized coordinates&quot; (x and y</span>
<span class="c1"># can refer to radius and angle, for example).</span>

<span class="c1"># The convention for coordinates is:</span>
<span class="c1">#   x increases to the right, y increases to the bottom.</span>
<span class="c1">#</span>
<span class="c1">#  +-----&gt; x          +------.</span>
<span class="c1">#  |                   \     .</span>
<span class="c1">#  |                    \   . a    (the angle thus increases clockwise too)</span>
<span class="c1">#  v y                 r \.</span>
<span class="c1">#</span>
<span class="c1"># This is the convention normally used in computer graphics, including SVGs,</span>
<span class="c1"># HTML Canvas, Qt, and PixiJS.</span>
<span class="c1">#</span>
<span class="c1"># The boxes (shapes) we use are:</span>
<span class="c1">#</span>
<span class="c1"># * Rectangle            w</span>
<span class="c1">#                 x,y +-----+      so (x,y) is its (left,top) corner</span>
<span class="c1">#                     |     | h    and (x+w,y+h) its (right,bottom) one</span>
<span class="c1">#                     +-----+</span>
<span class="c1">#</span>
<span class="c1"># * Annular sector       dr</span>
<span class="c1">#                  r,a .----.</span>
<span class="c1">#                     .     .      so (r,a) is its (inner,smaller-angle) corner</span>
<span class="c1">#                      \   . da    and (r+dr,a+da) its (outer,bigger-angle) one</span>
<span class="c1">#                       \.</span>

<span class="c1"># Drawing.</span>

<div class="viewcode-block" id="safe_string">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.safe_string">[docs]</a>
<span class="k">def</span> <span class="nf">safe_string</span><span class="p">(</span><span class="n">prop</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">prop</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>



<div class="viewcode-block" id="Drawer">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.Drawer">[docs]</a>
<span class="k">class</span> <span class="nc">Drawer</span><span class="p">:</span>
    <span class="s2">&quot;Base class (needs subclassing with extra functions to draw)&quot;</span>

    <span class="n">COLLAPSE_SIZE</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># anything that has less pixels will be outlined</span>

    <span class="n">MIN_SIZE</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># anything that has less pixels will not be drawn</span>

    <span class="n">TYPE</span> <span class="o">=</span> <span class="s1">&#39;base&#39;</span>  <span class="c1"># can be &#39;rect&#39; or &#39;circ&#39; for working drawers</span>

    <span class="n">NPANELS</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># number of drawing panels (including the aligned ones)</span>

<div class="viewcode-block" id="Drawer.__init__">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.Drawer.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">viewport</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">panel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                 <span class="n">limits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">collapsed_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">active</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">selected</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">searches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">layouts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tree_style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">include_props</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude_props</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="n">tree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewport</span> <span class="o">=</span> <span class="n">Box</span><span class="p">(</span><span class="o">*</span><span class="n">viewport</span><span class="p">)</span> <span class="k">if</span> <span class="n">viewport</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="o">=</span> <span class="n">panel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span> <span class="o">=</span> <span class="n">zoom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymax</span> <span class="o">=</span> <span class="n">limits</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collapsed_ids</span> <span class="o">=</span> <span class="n">collapsed_ids</span> <span class="ow">or</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># manually collapsed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">active</span> <span class="ow">or</span> <span class="n">get_empty_active</span><span class="p">()</span>  <span class="c1"># looks like (results, parents)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="n">selected</span> <span class="ow">or</span> <span class="p">{}</span>  <span class="c1"># looks like {node_id: (node, parents)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searches</span> <span class="o">=</span> <span class="n">searches</span> <span class="ow">or</span> <span class="p">{}</span>  <span class="c1"># looks like {text: (results, parents)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layouts</span> <span class="o">=</span> <span class="n">layouts</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include_props</span> <span class="o">=</span> <span class="n">include_props</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude_props</span> <span class="o">=</span> <span class="n">exclude_props</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span> <span class="o">=</span> <span class="n">tree_style</span> <span class="ow">or</span> <span class="n">TreeStyle</span><span class="p">()</span></div>


<div class="viewcode-block" id="Drawer.draw">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.Drawer.draw">[docs]</a>
    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Yield graphic elements to draw the tree&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outline</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># box surrounding the current collapsed nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># nodes that are curretly collapsed together</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeboxes</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># boxes surrounding all nodes and collapsed boxes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_dxs</span> <span class="o">=</span> <span class="p">[[]]</span>  <span class="c1"># lists of nodes dx (to find the max)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bdy_dys</span> <span class="o">=</span> <span class="p">[[]]</span>  <span class="c1"># lists of branch dys and total dys</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">aligned_grid_dxs</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_aligned_headers</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymin</span>
            <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">):</span>
                <span class="n">graphics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">it</span><span class="o">.</span><span class="n">first_visit</span><span class="p">:</span>
                    <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_first_visit</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">graphics</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_last_visit</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">graphics</span><span class="p">)</span>
                <span class="k">yield from</span> <span class="n">graphics</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_outline</span><span class="p">()</span>  <span class="c1"># send last surrounding outline</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">max_dx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span> <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeboxes</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">aligned_grid_dxs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_dx</span>

                <span class="c1"># To draw in preorder the boxes we found in postorder.</span>
                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeboxes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># (so they overlap nicely)</span></div>


<div class="viewcode-block" id="Drawer.on_first_visit">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.Drawer.on_first_visit">[docs]</a>
    <span class="k">def</span> <span class="nf">on_first_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">graphics</span><span class="p">):</span>
        <span class="s2">&quot;Update list of graphics to draw and return new position&quot;</span>
        <span class="n">box_node</span> <span class="o">=</span> <span class="n">make_box</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_size</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">node</span><span class="p">))</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">point</span>
        <span class="n">it</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">is_collapsed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_viewport</span><span class="p">(</span><span class="n">box_node</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bdy_dys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">box_node</span><span class="o">.</span><span class="n">dy</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">box_node</span><span class="o">.</span><span class="n">dy</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">it</span><span class="o">.</span><span class="n">descend</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># skip children</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">box_node</span><span class="o">.</span><span class="n">dy</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">it</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">sm_style</span><span class="p">[</span><span class="s1">&#39;draw_descendants&#39;</span><span class="p">]:</span>
            <span class="c1"># Skip descendants =&gt; in collapsed_ids</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collapsed_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">node_id</span><span class="p">)</span>

        <span class="n">is_manually_collapsed</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed_ids</span>

        <span class="k">if</span> <span class="n">is_manually_collapsed</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline</span><span class="p">:</span>
            <span class="n">graphics</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_outline</span><span class="p">()</span>  <span class="c1"># so we won&#39;t stack with its outline</span>

        <span class="k">if</span> <span class="n">is_manually_collapsed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_small</span><span class="p">(</span><span class="n">box_node</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node_dxs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box_node</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outline</span> <span class="o">=</span> <span class="n">stack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outline</span><span class="p">,</span> <span class="n">box_node</span><span class="p">)</span>
            <span class="n">it</span><span class="o">.</span><span class="n">descend</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># skip children</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">box_node</span><span class="o">.</span><span class="n">dy</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline</span><span class="p">:</span>
            <span class="n">graphics</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_outline</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bdy_dys</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

        <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_size</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">it</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">is_leaf</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_last_visit</span><span class="p">((</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">dy</span><span class="p">),</span> <span class="n">it</span><span class="p">,</span> <span class="n">graphics</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node_dxs</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y</span></div>


<div class="viewcode-block" id="Drawer.on_last_visit">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.Drawer.on_last_visit">[docs]</a>
    <span class="k">def</span> <span class="nf">on_last_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">graphics</span><span class="p">):</span>
        <span class="s2">&quot;Update list of graphics to draw and return new position&quot;</span>

        <span class="c1"># Searches</span>
        <span class="n">searched_by</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span> <span class="n">text</span> <span class="k">for</span> <span class="n">text</span><span class="p">,(</span><span class="n">results</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">searches</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">it</span><span class="o">.</span><span class="n">node</span> <span class="ow">in</span> <span class="n">results</span> <span class="p">)</span>
        <span class="c1"># Selection</span>
        <span class="n">selected_by</span> <span class="o">=</span> <span class="p">[</span> <span class="n">text</span> <span class="k">for</span> <span class="n">text</span><span class="p">,(</span><span class="n">results</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">it</span><span class="o">.</span><span class="n">node</span> <span class="ow">in</span> <span class="n">results</span> <span class="p">]</span>
        <span class="n">active_clade</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;active_clades&quot;</span> <span class="p">]</span> <span class="k">if</span> <span class="n">it</span><span class="o">.</span><span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">clades</span><span class="o">.</span><span class="n">results</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="c1"># Only if node is collapsed</span>
        <span class="n">selected_children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">active_children</span> <span class="o">=</span> <span class="n">TreeActive</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">):</span>
                <span class="n">searched_by</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="n">text</span> <span class="k">for</span> <span class="n">text</span><span class="p">,(</span><span class="n">results</span><span class="p">,</span><span class="n">parents</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">searches</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">node</span> <span class="ow">in</span> <span class="n">results</span> <span class="ow">or</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">parents</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">active_children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_children</span><span class="p">()</span>
                <span class="n">selected_children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_selected_children</span><span class="p">()</span>

            <span class="n">graphics</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_outline</span><span class="p">()</span>

        <span class="n">x_after</span><span class="p">,</span> <span class="n">y_after</span> <span class="o">=</span> <span class="n">point</span>
        <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_size</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="n">x_before</span><span class="p">,</span> <span class="n">y_before</span> <span class="o">=</span> <span class="n">x_after</span> <span class="o">-</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y_after</span> <span class="o">-</span> <span class="n">dy</span>

        <span class="n">content_graphics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">draw_content</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="n">x_before</span><span class="p">,</span> <span class="n">y_before</span><span class="p">),</span>
            <span class="n">active_children</span><span class="p">,</span> <span class="n">selected_children</span><span class="p">))</span>
        <span class="n">graphics</span> <span class="o">+=</span> <span class="n">content_graphics</span>

        <span class="n">ndx</span> <span class="o">=</span> <span class="p">(</span><span class="n">drawn_size</span><span class="p">(</span><span class="n">content_graphics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_box</span><span class="p">)</span><span class="o">.</span><span class="n">dx</span> <span class="k">if</span> <span class="n">it</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">is_leaf</span>
               <span class="k">else</span> <span class="p">(</span><span class="n">dx</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_dxs</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="ow">or</span> <span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_dxs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ndx</span><span class="p">)</span>

        <span class="n">box</span> <span class="o">=</span> <span class="n">Box</span><span class="p">(</span><span class="n">x_before</span><span class="p">,</span> <span class="n">y_before</span><span class="p">,</span> <span class="n">ndx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeboxes</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_nodebox</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">it</span><span class="o">.</span><span class="n">node_id</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">searched_by</span><span class="p">)</span> <span class="o">+</span> <span class="n">selected_by</span> <span class="o">+</span> <span class="n">active_clade</span><span class="p">,</span>
                <span class="p">{</span> <span class="s1">&#39;fill&#39;</span><span class="p">:</span> <span class="n">it</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">sm_style</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bgcolor&#39;</span><span class="p">)</span> <span class="p">})</span>

        <span class="k">return</span> <span class="n">x_before</span><span class="p">,</span> <span class="n">y_after</span><span class="p">;</span></div>


<div class="viewcode-block" id="Drawer.draw_content">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.Drawer.draw_content">[docs]</a>
    <span class="k">def</span> <span class="nf">draw_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">active_children</span><span class="o">=</span><span class="n">TreeActive</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">selected_children</span><span class="o">=</span><span class="p">[]):</span>
        <span class="s2">&quot;Yield the node content&#39;s graphic elements&quot;</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">point</span>
        <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_size</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="c1"># Find branch dy of first child (bdy0), last (bdy1), and self (bdy).</span>
        <span class="n">bdy_dys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bdy_dys</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>  <span class="c1"># bdy_dys[i] == (bdy, dy)</span>
        <span class="n">bdy0</span> <span class="o">=</span> <span class="n">bdy1</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># branch dys of the first and last children</span>
        <span class="k">if</span> <span class="n">bdy_dys</span><span class="p">:</span>
            <span class="n">bdy0</span> <span class="o">=</span> <span class="n">bdy_dys</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">bdy1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">bdy_dy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">bdy_dy</span> <span class="ow">in</span> <span class="n">bdy_dys</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">bdy_dys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">bdy</span> <span class="o">=</span> <span class="p">(</span><span class="n">bdy0</span> <span class="o">+</span> <span class="n">bdy1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># this node&#39;s branch dy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bdy_dys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">bdy</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span> <span class="p">)</span>

        <span class="c1"># Collapsed nodes will be drawn from self.draw_collapsed()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">is_collapsed</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">is_leaf</span><span class="p">:</span>
            <span class="n">bdy0_</span><span class="p">,</span> <span class="n">bdy1_</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">is_leaf</span> <span class="k">else</span> <span class="p">(</span><span class="n">bdy0</span><span class="p">,</span> <span class="n">bdy1</span><span class="p">)</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">bdy</span><span class="p">,</span> <span class="n">bdy0_</span><span class="p">,</span> <span class="n">bdy1_</span><span class="p">,</span>
                    <span class="n">active_children</span><span class="p">,</span> <span class="n">selected_children</span><span class="p">)</span>

        <span class="c1"># Draw the branch line (&quot;lengthline&quot;) and a line spanning all children.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">node_style</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">sm_style</span>
            <span class="k">if</span> <span class="n">dx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">parent_of</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">text</span> <span class="k">for</span> <span class="n">text</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">parents</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">searches</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">parents</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">parent_of</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">text</span> <span class="k">for</span> <span class="n">text</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">parents</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">parents</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">hz_line_style</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">node_style</span><span class="p">[</span><span class="s1">&#39;hz_line_type&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;stroke-width&#39;</span><span class="p">:</span> <span class="n">node_style</span><span class="p">[</span><span class="s1">&#39;hz_line_width&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;stroke&#39;</span><span class="p">:</span> <span class="n">node_style</span><span class="p">[</span><span class="s1">&#39;hz_line_color&#39;</span><span class="p">],</span>
                <span class="p">}</span>
                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_lengthline</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">bdy</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">bdy</span><span class="p">),</span>
                                <span class="nb">list</span><span class="p">(</span><span class="n">parent_of</span><span class="p">),</span> <span class="n">style</span><span class="o">=</span><span class="n">hz_line_style</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">bdy0</span> <span class="o">!=</span> <span class="n">bdy1</span><span class="p">:</span>
                <span class="n">vt_line_style</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">node_style</span><span class="p">[</span><span class="s1">&#39;vt_line_type&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;stroke-width&#39;</span><span class="p">:</span> <span class="n">node_style</span><span class="p">[</span><span class="s1">&#39;vt_line_width&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;stroke&#39;</span><span class="p">:</span> <span class="n">node_style</span><span class="p">[</span><span class="s1">&#39;vt_line_color&#39;</span><span class="p">],</span>
                <span class="p">}</span>
                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_childrenline</span><span class="p">((</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">bdy0</span><span class="p">),</span>
                                                  <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">bdy1</span><span class="p">),</span>
                                                  <span class="n">style</span><span class="o">=</span><span class="n">vt_line_style</span><span class="p">)</span>

            <span class="n">active_node</span> <span class="o">=</span> <span class="s2">&quot;selected_results_active_nodes&quot;</span>\
                <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">results</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">nodedot_style</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="n">node_style</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">node_style</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;fill&#39;</span><span class="p">:</span> <span class="n">node_style</span><span class="p">[</span><span class="s1">&#39;fgcolor&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;opacity&#39;</span><span class="p">:</span> <span class="n">node_style</span><span class="p">[</span><span class="s1">&#39;fgopacity&#39;</span><span class="p">],</span>
            <span class="p">}</span>

            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_nodedot</span><span class="p">((</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">bdy</span><span class="p">),</span>
                    <span class="n">dy</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">active_node</span><span class="p">,</span> <span class="n">nodedot_style</span><span class="p">)</span></div>


<div class="viewcode-block" id="Drawer.draw_aligned_headers">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.Drawer.draw_aligned_headers">[docs]</a>
    <span class="k">def</span> <span class="nf">draw_aligned_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Draw aligned panel headers</span>
        <span class="k">def</span> <span class="nf">it_fits</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">box</span>
            <span class="k">return</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">zx</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MIN_SIZE</span> <span class="ow">and</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">zy</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MIN_SIZE</span>

        <span class="k">def</span> <span class="nf">draw_face</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">n_row</span><span class="p">,</span> <span class="n">n_col</span><span class="p">,</span> <span class="n">dx_before</span><span class="p">,</span> <span class="n">dy_before</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">face</span><span class="o">.</span><span class="n">get_content</span><span class="p">():</span>
                <span class="n">box</span> <span class="o">=</span> <span class="n">face</span><span class="o">.</span><span class="n">compute_bounding_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">size</span><span class="p">,</span>
                            <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">pos</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">n_row</span><span class="p">,</span> <span class="n">n_col</span><span class="p">,</span>
                            <span class="n">dx_before</span><span class="p">,</span> <span class="n">dy_before</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">it_fits</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span> <span class="ow">and</span> <span class="n">face</span><span class="o">.</span><span class="n">fits</span><span class="p">())</span> <span class="ow">or</span> <span class="n">face</span><span class="o">.</span><span class="n">always_drawn</span><span class="p">:</span>
                    <span class="k">yield from</span> <span class="n">face</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">draw_faces_at_pos</span><span class="p">(</span><span class="n">faces</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
            <span class="n">n_col</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">faces</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">default</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">dx_before</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">face_list</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">faces</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">col</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Avoid changing-size error when zooming very quickly</span>
                    <span class="n">dxs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">faces</span><span class="o">.</span><span class="n">_grid_dxs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                    <span class="n">dx_before</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dxs</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">col</span><span class="p">)</span>
                <span class="n">dx_max</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">dy_before</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">n_row</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_list</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">face</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">face_list</span><span class="p">):</span>
                    <span class="n">drawn_face</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">draw_face</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">n_row</span><span class="p">,</span> <span class="n">n_col</span><span class="p">,</span>
                            <span class="n">dx_before</span><span class="p">,</span> <span class="n">dy_before</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">drawn_face</span><span class="p">:</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">face</span><span class="o">.</span><span class="n">get_box</span><span class="p">()</span>
                        <span class="n">hz_padding</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">face</span><span class="o">.</span><span class="n">padding_x</span> <span class="o">/</span> <span class="n">zx</span>
                        <span class="n">vt_padding</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">face</span><span class="o">.</span><span class="n">padding_y</span> <span class="o">/</span> <span class="n">zy</span>
                        <span class="n">dx_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dx_max</span><span class="p">,</span> <span class="p">(</span><span class="n">dx</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">hz_padding</span><span class="p">)</span>
                        <span class="n">dy_before</span> <span class="o">+=</span> <span class="n">dy</span> <span class="o">+</span> <span class="n">vt_padding</span>
                        <span class="k">yield from</span> <span class="n">drawn_face</span>
                <span class="c1"># Update dx_before</span>
                <span class="n">dx_grid</span> <span class="o">=</span> <span class="n">faces</span><span class="o">.</span><span class="n">_grid_dxs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Compute aligned grid</span>
                    <span class="n">dx_grid</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dx_grid</span><span class="p">,</span> <span class="n">dx_max</span><span class="p">)</span>
                    <span class="n">faces</span><span class="o">.</span><span class="n">_grid_dxs</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx_grid</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dx_before</span> <span class="o">+=</span> <span class="n">dx_grid</span>

        <span class="n">size</span> <span class="o">=</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewport</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewport</span><span class="o">.</span><span class="n">dy</span> <span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">zy</span><span class="p">,</span> <span class="n">zx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span>
        <span class="n">graphics</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">deque</span><span class="p">(</span><span class="n">draw_faces_at_pos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">aligned_panel_header</span><span class="p">,</span>
                    <span class="s2">&quot;aligned_bottom&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">graphics</span> <span class="o">+=</span> <span class="n">draw_faces_at_pos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">aligned_panel_header</span><span class="p">,</span>
                    <span class="s2">&quot;aligned_bottom&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">deque</span><span class="p">(</span><span class="n">draw_faces_at_pos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">aligned_panel_footer</span><span class="p">,</span>
                    <span class="s2">&quot;aligned_top&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">graphics</span> <span class="o">+=</span> <span class="n">draw_faces_at_pos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">aligned_panel_footer</span><span class="p">,</span>
                    <span class="s2">&quot;aligned_top&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">graphics</span></div>


<div class="viewcode-block" id="Drawer.get_outline">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.Drawer.get_outline">[docs]</a>
    <span class="k">def</span> <span class="nf">get_outline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Yield the outline representation.&quot;&quot;&quot;</span>
        <span class="n">graphics</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># will contain the graphic elements to draw</span>

        <span class="n">node0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">uncollapse</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">node0</span><span class="o">.</span><span class="n">is_leaf</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline</span>
        <span class="n">collapsed_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_collapsed_node</span><span class="p">()</span>

        <span class="n">searched_by</span> <span class="o">=</span> <span class="p">[</span><span class="n">text</span> <span class="k">for</span> <span class="n">text</span><span class="p">,(</span><span class="n">results</span><span class="p">,</span><span class="n">parents</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">searches</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                       <span class="k">if</span> <span class="n">collapsed_node</span> <span class="ow">in</span> <span class="n">results</span>
                       <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">node</span> <span class="ow">in</span> <span class="n">results</span> <span class="ow">or</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">parents</span>
                              <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span><span class="p">)]</span>
        <span class="n">selected_by</span> <span class="o">=</span> <span class="p">[</span><span class="n">text</span> <span class="k">for</span> <span class="n">text</span><span class="p">,(</span><span class="n">results</span><span class="p">,</span><span class="n">parents</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                       <span class="k">if</span> <span class="n">collapsed_node</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
        <span class="n">active_clade</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;active_clades&quot;</span> <span class="p">]</span> <span class="k">if</span> <span class="n">collapsed_node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">clades</span><span class="o">.</span><span class="n">results</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">active_children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_children</span><span class="p">()</span>
        <span class="n">selected_children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_selected_children</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">uncollapse</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bdy_dys</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="n">graphics</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_content</span><span class="p">(</span><span class="n">node0</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bdy_dys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outline</span><span class="o">.</span><span class="n">dy</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline</span><span class="o">.</span><span class="n">dy</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">graphics</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_collapsed</span><span class="p">(</span><span class="n">collapsed_node</span><span class="p">,</span> <span class="n">active_children</span><span class="p">,</span> <span class="n">selected_children</span><span class="p">)</span>

        <span class="n">is_manually_collapsed</span> <span class="o">=</span> <span class="n">collapsed_node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span>
        <span class="n">is_small</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_small</span><span class="p">(</span><span class="n">make_box</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">node_size</span><span class="p">(</span><span class="n">collapsed_node</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">ndx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outline</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">drawn_size</span><span class="p">(</span><span class="n">graphics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_box</span><span class="p">)</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_dxs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ndx</span><span class="p">)</span>

        <span class="c1"># Draw collapsed node nodebox when necessary</span>
        <span class="k">if</span> <span class="n">is_manually_collapsed</span> <span class="ow">or</span> <span class="n">is_small</span> <span class="ow">or</span> <span class="n">dist</span><span class="p">(</span><span class="n">collapsed_node</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">collapsed_node</span><span class="o">.</span><span class="n">name</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_popup_props</span><span class="p">(</span><span class="n">collapsed_node</span><span class="p">)</span>

            <span class="n">node_id</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">collapsed_node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_manually_collapsed</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="n">box</span> <span class="o">=</span> <span class="n">dh</span><span class="o">.</span><span class="n">draw_nodebox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flush_outline</span><span class="p">(</span><span class="n">ndx</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span>
                    <span class="n">properties</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">searched_by</span> <span class="o">+</span> <span class="n">selected_by</span> <span class="o">+</span> <span class="n">active_clade</span><span class="p">,</span>
                    <span class="p">{</span> <span class="s1">&#39;fill&#39;</span><span class="p">:</span> <span class="n">collapsed_node</span><span class="o">.</span><span class="n">sm_style</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bgcolor&#39;</span><span class="p">)</span> <span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeboxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush_outline</span><span class="p">()</span>

        <span class="k">yield from</span> <span class="n">graphics</span></div>


<div class="viewcode-block" id="Drawer.flush_outline">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.Drawer.flush_outline">[docs]</a>
    <span class="k">def</span> <span class="nf">flush_outline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minimum_dx</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="s2">&quot;Return box outlining the collapsed nodes and reset the current outline&quot;</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outline</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">Box</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">minimum_dx</span><span class="p">),</span> <span class="n">dy</span><span class="p">)</span></div>


<div class="viewcode-block" id="Drawer.get_collapsed_node">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.Drawer.get_collapsed_node">[docs]</a>
    <span class="k">def</span> <span class="nf">get_collapsed_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get node that will be rendered as a collapsed node.</span>
<span class="sd">        Either the only node collapsed or the parent of all collapsed nodes.&quot;&quot;&quot;</span>

        <span class="n">node0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">node0</span><span class="o">.</span><span class="n">is_collapsed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">node0</span>

        <span class="n">parent</span> <span class="o">=</span> <span class="n">node0</span><span class="o">.</span><span class="n">up</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">up</span> <span class="o">==</span> <span class="n">parent</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="ow">and</span>\
           <span class="nb">all</span><span class="p">(</span><span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">):</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">is_collapsed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">parent</span>

        <span class="c1"># No node inside the tree contains all the collapsed nodes</span>
        <span class="c1"># Create a fictional node whose children are the collapsed nodes</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">...</span> <span class="kn">import</span> <span class="n">Tree</span> <span class="c1"># avoid circular import</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>

        <span class="n">node</span><span class="o">.</span><span class="n">is_collapsed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">node</span><span class="o">.</span><span class="n">is_initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">node</span><span class="o">.</span><span class="n">_children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span>  <span class="c1"># add avoiding parent override</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline</span>
        <span class="n">node</span><span class="o">.</span><span class="n">dist</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">node</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">Size</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">node</span></div>


<div class="viewcode-block" id="Drawer.is_fully_collapsed">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.Drawer.is_fully_collapsed">[docs]</a>
    <span class="k">def</span> <span class="nf">is_fully_collapsed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collapsed_node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns true if collapsed_node is utterly collapsed,</span>
<span class="sd">        i.e. has no branch width&quot;&quot;&quot;</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline</span>
        <span class="n">is_manually_collapsed</span> <span class="o">=</span> <span class="n">collapsed_node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span>
        <span class="n">box_node</span> <span class="o">=</span> <span class="n">make_box</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_size</span><span class="p">(</span><span class="n">collapsed_node</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">is_manually_collapsed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_small</span><span class="p">(</span><span class="n">box_node</span><span class="p">)</span></div>


<div class="viewcode-block" id="Drawer.get_active_children">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.Drawer.get_active_children">[docs]</a>
    <span class="k">def</span> <span class="nf">get_active_children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
        <span class="n">nodes</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span><span class="p">)</span>
        <span class="n">clades</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">clades</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
        <span class="n">clades</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">clades</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TreeActive</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">clades</span><span class="p">)</span></div>


<div class="viewcode-block" id="Drawer.get_selected_children">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.Drawer.get_selected_children">[docs]</a>
    <span class="k">def</span> <span class="nf">get_selected_children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">selected_children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">text</span><span class="p">,(</span><span class="n">results</span><span class="p">,</span> <span class="n">parents</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">hits</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">results</span><span class="p">)</span>
            <span class="n">hits</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">parents</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hits</span><span class="p">:</span>
                <span class="n">selected_children</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">text</span><span class="p">,</span> <span class="n">hits</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">selected_children</span></div>


<div class="viewcode-block" id="Drawer.get_popup_props">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.Drawer.get_popup_props">[docs]</a>
    <span class="k">def</span> <span class="nf">get_popup_props</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return dictionary of web-safe node properties (to use in a popup).&quot;&quot;&quot;</span>
        <span class="n">include_props</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">include_props</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_props</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                         <span class="k">else</span> <span class="n">node</span><span class="o">.</span><span class="n">props</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">safe_string</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">include_props</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">props</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude_props</span> <span class="ow">or</span> <span class="p">[])}</span></div>

        <span class="c1"># NOTE: We do it this way so the properties appear in the</span>
        <span class="c1"># order given in include_props.</span>


    <span class="c1"># These are the 2 functions that the user overloads to choose what to draw</span>
    <span class="c1"># when representing a node and a group of collapsed nodes:</span>

<div class="viewcode-block" id="Drawer.draw_node">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.Drawer.draw_node">[docs]</a>
    <span class="k">def</span> <span class="nf">draw_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">bdx</span><span class="p">,</span> <span class="n">bdy</span><span class="p">,</span> <span class="n">bdy0</span><span class="p">,</span> <span class="n">bdy1</span><span class="p">,</span> <span class="n">active_children</span><span class="o">=</span><span class="n">TreeActive</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">selected_children</span><span class="o">=</span><span class="p">[]):</span>
        <span class="s2">&quot;Yield graphic elements to draw the contents of the node&quot;</span>
        <span class="c1"># bdx: branch dx (width)</span>
        <span class="c1"># bdy: branch dy (height)</span>
        <span class="c1"># bdy0: fist child branch dy (height)</span>
        <span class="c1"># bdy1: last child branch dy (height)</span>
        <span class="c1"># selected_children: list of selected nodes (under this node if collapsed or</span>
        <span class="c1">#              this node if not collapsed) (to be tagged in front end)</span>
        <span class="k">yield from</span> <span class="p">[]</span>  <span class="c1"># only drawn if the node&#39;s content is visible</span></div>


<div class="viewcode-block" id="Drawer.draw_collapsed">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.Drawer.draw_collapsed">[docs]</a>
    <span class="k">def</span> <span class="nf">draw_collapsed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collapsed_node</span><span class="p">,</span> <span class="n">active_children</span><span class="o">=</span><span class="n">TreeActive</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">selected_children</span><span class="o">=</span><span class="p">[]):</span>
        <span class="s2">&quot;Yield graphic elements to draw the list of nodes in self.collapsed&quot;</span>
        <span class="c1"># selected_children: list of selected nodes under this node</span>
        <span class="k">yield from</span> <span class="p">[]</span>  <span class="c1"># they are always drawn (only visible nodes can collapse)</span></div>
</div>

        <span class="c1"># Uses self.collapsed and self.outline to extract and place info.</span>


<div class="viewcode-block" id="DrawerRect">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerRect">[docs]</a>
<span class="k">class</span> <span class="nc">DrawerRect</span><span class="p">(</span><span class="n">Drawer</span><span class="p">):</span>
    <span class="s2">&quot;Minimal functional drawer for a rectangular representation&quot;</span>

    <span class="n">TYPE</span> <span class="o">=</span> <span class="s1">&#39;rect&#39;</span>

<div class="viewcode-block" id="DrawerRect.in_viewport">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerRect.in_viewport">[docs]</a>
    <span class="k">def</span> <span class="nf">in_viewport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewport</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pos</span> <span class="o">!=</span> <span class="s1">&#39;aligned&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dh</span><span class="o">.</span><span class="n">intersects_box</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">viewport</span><span class="p">,</span> <span class="n">box</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dh</span><span class="o">.</span><span class="n">intersects_segment</span><span class="p">(</span><span class="n">dh</span><span class="o">.</span><span class="n">get_ys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">viewport</span><span class="p">),</span> <span class="n">dh</span><span class="o">.</span><span class="n">get_ys</span><span class="p">(</span><span class="n">box</span><span class="p">))</span></div>


<div class="viewcode-block" id="DrawerRect.node_size">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerRect.node_size">[docs]</a>
    <span class="k">def</span> <span class="nf">node_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="s2">&quot;Return the size of a node (its content and its children)&quot;</span>
        <span class="k">return</span> <span class="n">Size</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="DrawerRect.content_size">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerRect.content_size">[docs]</a>
    <span class="k">def</span> <span class="nf">content_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="s2">&quot;Return the size of the node&#39;s content&quot;</span>
        <span class="k">return</span> <span class="n">Size</span><span class="p">(</span><span class="n">dist</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="DrawerRect.is_small">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerRect.is_small">[docs]</a>
    <span class="k">def</span> <span class="nf">is_small</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
        <span class="n">zx</span><span class="p">,</span> <span class="n">zy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span>
        <span class="k">return</span> <span class="n">box</span><span class="o">.</span><span class="n">dy</span> <span class="o">*</span> <span class="n">zy</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLLAPSE_SIZE</span></div>


<div class="viewcode-block" id="DrawerRect.get_box">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerRect.get_box">[docs]</a>
    <span class="k">def</span> <span class="nf">get_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="n">zx</span><span class="p">,</span> <span class="n">zy</span><span class="p">,</span> <span class="n">za</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">zoom</span> <span class="o">=</span> <span class="p">(</span><span class="n">zx</span><span class="p">,</span> <span class="n">zy</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zoom</span> <span class="o">=</span> <span class="p">(</span><span class="n">za</span><span class="p">,</span> <span class="n">zy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">get_rect</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">zoom</span><span class="p">)</span></div>


<div class="viewcode-block" id="DrawerRect.draw_lengthline">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerRect.draw_lengthline">[docs]</a>
    <span class="k">def</span> <span class="nf">draw_lengthline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">parent_of</span><span class="p">,</span> <span class="n">style</span><span class="p">):</span>
        <span class="s2">&quot;Yield a line representing a length&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">dh</span><span class="o">.</span><span class="n">draw_line</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="s1">&#39;lengthline&#39;</span><span class="p">,</span> <span class="n">parent_of</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewport</span> <span class="ow">or</span> <span class="n">dh</span><span class="o">.</span><span class="n">intersects_box</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">viewport</span><span class="p">,</span> <span class="n">get_rect</span><span class="p">(</span><span class="n">line</span><span class="p">)):</span>
            <span class="k">yield</span> <span class="n">line</span></div>


<div class="viewcode-block" id="DrawerRect.draw_childrenline">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerRect.draw_childrenline">[docs]</a>
    <span class="k">def</span> <span class="nf">draw_childrenline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">style</span><span class="p">):</span>
        <span class="s2">&quot;Yield a line spanning children that starts at p1 and ends at p2&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">dh</span><span class="o">.</span><span class="n">draw_line</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="s1">&#39;childrenline&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewport</span> <span class="ow">or</span> <span class="n">dh</span><span class="o">.</span><span class="n">intersects_box</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">viewport</span><span class="p">,</span> <span class="n">get_rect</span><span class="p">(</span><span class="n">line</span><span class="p">)):</span>
            <span class="k">yield</span> <span class="n">line</span></div>


<div class="viewcode-block" id="DrawerRect.draw_nodedot">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerRect.draw_nodedot">[docs]</a>
    <span class="k">def</span> <span class="nf">draw_nodedot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="n">active_node</span><span class="p">,</span> <span class="n">style</span><span class="p">):</span>
        <span class="s2">&quot;Yield circle or square on node based on node.sm_style&quot;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="n">style</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">active_node</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">size</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fill</span> <span class="o">=</span> <span class="n">style</span><span class="p">[</span><span class="s1">&#39;fill&#39;</span><span class="p">]</span>
            <span class="n">nodedot_style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fill&#39;</span><span class="p">:</span><span class="n">fill</span><span class="p">,</span> <span class="s1">&#39;opacity&#39;</span><span class="p">:</span> <span class="n">style</span><span class="p">[</span><span class="s1">&#39;opacity&#39;</span><span class="p">]}</span>
            <span class="k">if</span> <span class="n">style</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;circle&#39;</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">dh</span><span class="o">.</span><span class="n">draw_circle</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
                        <span class="n">circle_type</span><span class="o">=</span><span class="s1">&#39;nodedot &#39;</span> <span class="o">+</span> <span class="n">active_node</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">nodedot_style</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">style</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;square&#39;</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">center</span>
                <span class="n">zx</span><span class="p">,</span> <span class="n">zy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span>
                <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">size</span> <span class="o">/</span> <span class="n">zx</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">size</span> <span class="o">/</span> <span class="n">zy</span>
                <span class="n">box</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">dx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">dy</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">dh</span><span class="o">.</span><span class="n">draw_rect</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">rect_type</span><span class="o">=</span><span class="s1">&#39;nodedot &#39;</span> <span class="o">+</span> <span class="n">active_node</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">nodedot_style</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">style</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;triangle&quot;</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">center</span>
                <span class="n">zx</span><span class="p">,</span> <span class="n">zy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span>
                <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">size</span> <span class="o">/</span> <span class="n">zx</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">size</span> <span class="o">/</span> <span class="n">zy</span>
                <span class="n">box</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">dx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">dy</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">dh</span><span class="o">.</span><span class="n">draw_triangle</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="n">triangle_type</span><span class="o">=</span><span class="s1">&#39;nodedot &#39;</span> <span class="o">+</span> <span class="n">active_node</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">nodedot_style</span><span class="p">)</span></div>


<div class="viewcode-block" id="DrawerRect.draw_nodebox">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerRect.draw_nodebox">[docs]</a>
    <span class="k">def</span> <span class="nf">draw_nodebox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">searched_by</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">dh</span><span class="o">.</span><span class="n">draw_nodebox</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_popup_props</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
                <span class="n">node_id</span><span class="p">,</span> <span class="n">searched_by</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span></div>


<div class="viewcode-block" id="DrawerRect.draw_collapsed">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerRect.draw_collapsed">[docs]</a>
    <span class="k">def</span> <span class="nf">draw_collapsed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collapsed_node</span><span class="p">,</span> <span class="n">active_children</span><span class="o">=</span><span class="n">TreeActive</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">selected_children</span><span class="o">=</span><span class="p">[]):</span>
        <span class="c1"># Draw line to farthest leaf under collapsed node</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline</span>

        <span class="n">p1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">dh</span><span class="o">.</span><span class="n">draw_line</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="s1">&#39;lengthline&#39;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="DrawerCirc">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerCirc">[docs]</a>
<span class="k">class</span> <span class="nc">DrawerCirc</span><span class="p">(</span><span class="n">Drawer</span><span class="p">):</span>
    <span class="s2">&quot;Minimal functional drawer for a circular representation&quot;</span>

    <span class="n">TYPE</span> <span class="o">=</span> <span class="s1">&#39;circ&#39;</span>

<div class="viewcode-block" id="DrawerCirc.__init__">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerCirc.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">viewport</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">panel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                 <span class="n">limits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">collapsed_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">selected</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">searches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">layouts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tree_style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">include_props</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude_props</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">viewport</span><span class="p">,</span> <span class="n">panel</span><span class="p">,</span> <span class="n">zoom</span><span class="p">,</span>
                         <span class="n">limits</span><span class="p">,</span> <span class="n">collapsed_ids</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">selected</span><span class="p">,</span> <span class="n">searches</span><span class="p">,</span>
                         <span class="n">layouts</span><span class="p">,</span> <span class="n">tree_style</span><span class="p">,</span>
                         <span class="n">include_props</span><span class="o">=</span><span class="n">include_props</span><span class="p">,</span>
                         <span class="n">exclude_props</span><span class="o">=</span><span class="n">exclude_props</span><span class="p">)</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;zoom must be equal in x and y&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">limits</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymax</span> <span class="o">=</span> <span class="o">-</span><span class="n">pi</span><span class="p">,</span> <span class="n">pi</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dy2da</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ymax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymin</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="DrawerCirc.in_viewport">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerCirc.in_viewport">[docs]</a>
    <span class="k">def</span> <span class="nf">in_viewport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewport</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dh</span><span class="o">.</span><span class="n">intersects_segment</span><span class="p">((</span><span class="o">-</span><span class="n">pi</span><span class="p">,</span> <span class="o">+</span><span class="n">pi</span><span class="p">),</span> <span class="n">dh</span><span class="o">.</span><span class="n">get_ys</span><span class="p">(</span><span class="n">box</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pos</span> <span class="o">!=</span> <span class="s1">&#39;aligned&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">dh</span><span class="o">.</span><span class="n">intersects_box</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">viewport</span><span class="p">,</span> <span class="n">dh</span><span class="o">.</span><span class="n">circumrect</span><span class="p">(</span><span class="n">box</span><span class="p">))</span> <span class="ow">and</span>
                    <span class="n">dh</span><span class="o">.</span><span class="n">intersects_segment</span><span class="p">((</span><span class="o">-</span><span class="n">pi</span><span class="p">,</span> <span class="o">+</span><span class="n">pi</span><span class="p">),</span> <span class="n">dh</span><span class="o">.</span><span class="n">get_ys</span><span class="p">(</span><span class="n">box</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dh</span><span class="o">.</span><span class="n">intersects_angles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">viewport</span><span class="p">,</span> <span class="n">box</span><span class="p">)</span></div>


<div class="viewcode-block" id="DrawerCirc.flush_outline">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerCirc.flush_outline">[docs]</a>
    <span class="k">def</span> <span class="nf">flush_outline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minimum_dr</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="s2">&quot;Return box outlining the collapsed nodes&quot;</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">da</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">flush_outline</span><span class="p">(</span><span class="n">minimum_dr</span><span class="p">)</span>
        <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">dh</span><span class="o">.</span><span class="n">clip_angles</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">da</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Box</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">a2</span> <span class="o">-</span> <span class="n">a1</span><span class="p">)</span></div>


<div class="viewcode-block" id="DrawerCirc.node_size">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerCirc.node_size">[docs]</a>
    <span class="k">def</span> <span class="nf">node_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="s2">&quot;Return the size of a node (its content and its children)&quot;</span>
        <span class="k">return</span> <span class="n">Size</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy2da</span><span class="p">)</span></div>


<div class="viewcode-block" id="DrawerCirc.content_size">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerCirc.content_size">[docs]</a>
    <span class="k">def</span> <span class="nf">content_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="s2">&quot;Return the size of the node&#39;s content&quot;</span>
        <span class="k">return</span> <span class="n">Size</span><span class="p">(</span><span class="n">dist</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy2da</span><span class="p">)</span></div>


<div class="viewcode-block" id="DrawerCirc.is_small">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerCirc.is_small">[docs]</a>
    <span class="k">def</span> <span class="nf">is_small</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># zx == zy in this drawer</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">da</span> <span class="o">=</span> <span class="n">box</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">dr</span><span class="p">)</span> <span class="o">*</span> <span class="n">da</span> <span class="o">*</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLLAPSE_SIZE</span></div>


<div class="viewcode-block" id="DrawerCirc.get_box">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerCirc.get_box">[docs]</a>
    <span class="k">def</span> <span class="nf">get_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_asec</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span><span class="p">)</span></div>


<div class="viewcode-block" id="DrawerCirc.draw_lengthline">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerCirc.draw_lengthline">[docs]</a>
    <span class="k">def</span> <span class="nf">draw_lengthline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">parent_of</span><span class="p">,</span> <span class="n">style</span><span class="p">):</span>
        <span class="s2">&quot;Yield a line representing a length&quot;</span>
        <span class="k">if</span> <span class="o">-</span><span class="n">pi</span> <span class="o">&lt;=</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="p">:</span>  <span class="c1"># NOTE: the angles p1[1] and p2[1] are equal</span>
            <span class="k">yield</span> <span class="n">dh</span><span class="o">.</span><span class="n">draw_line</span><span class="p">(</span><span class="n">dh</span><span class="o">.</span><span class="n">cartesian</span><span class="p">(</span><span class="n">p1</span><span class="p">),</span> <span class="n">dh</span><span class="o">.</span><span class="n">cartesian</span><span class="p">(</span><span class="n">p2</span><span class="p">),</span>
                            <span class="s1">&#39;lengthline&#39;</span><span class="p">,</span> <span class="n">parent_of</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span></div>


<div class="viewcode-block" id="DrawerCirc.draw_childrenline">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerCirc.draw_childrenline">[docs]</a>
    <span class="k">def</span> <span class="nf">draw_childrenline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">style</span><span class="p">):</span>
        <span class="s2">&quot;Yield an arc spanning children that starts at p1 and ends at p2&quot;</span>
        <span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">a1</span><span class="p">),</span> <span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span> <span class="o">=</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span>
        <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">dh</span><span class="o">.</span><span class="n">clip_angles</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a1</span> <span class="o">&lt;</span> <span class="n">a2</span><span class="p">:</span>
            <span class="n">is_large</span> <span class="o">=</span> <span class="n">a2</span> <span class="o">-</span> <span class="n">a1</span> <span class="o">&gt;</span> <span class="n">pi</span>
            <span class="k">yield</span> <span class="n">dh</span><span class="o">.</span><span class="n">draw_arc</span><span class="p">(</span><span class="n">dh</span><span class="o">.</span><span class="n">cartesian</span><span class="p">((</span><span class="n">r1</span><span class="p">,</span> <span class="n">a1</span><span class="p">)),</span> <span class="n">dh</span><span class="o">.</span><span class="n">cartesian</span><span class="p">((</span><span class="n">r2</span><span class="p">,</span> <span class="n">a2</span><span class="p">)),</span>
                             <span class="n">is_large</span><span class="p">,</span> <span class="s1">&#39;childrenline&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span></div>


<div class="viewcode-block" id="DrawerCirc.draw_nodedot">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerCirc.draw_nodedot">[docs]</a>
    <span class="k">def</span> <span class="nf">draw_nodedot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="n">active_node</span><span class="p">,</span> <span class="n">style</span><span class="p">):</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">center</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="n">style</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">active_node</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">size</span><span class="p">)</span>

        <span class="k">if</span> <span class="o">-</span><span class="n">pi</span> <span class="o">&lt;</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">pi</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fill</span> <span class="o">=</span> <span class="n">style</span><span class="p">[</span><span class="s1">&#39;fill&#39;</span><span class="p">]</span>
            <span class="n">nodedot_style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fill&#39;</span><span class="p">:</span><span class="n">fill</span><span class="p">,</span> <span class="s1">&#39;opacity&#39;</span><span class="p">:</span> <span class="n">style</span><span class="p">[</span><span class="s1">&#39;opacity&#39;</span><span class="p">]}</span>
            <span class="k">if</span> <span class="n">style</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;circle&#39;</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">dh</span><span class="o">.</span><span class="n">draw_circle</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
                          <span class="n">circle_type</span><span class="o">=</span><span class="s1">&#39;nodedot &#39;</span> <span class="o">+</span> <span class="n">active_node</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">nodedot_style</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">style</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;square&#39;</span><span class="p">:</span>
                <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># same zoom in x and y</span>
                <span class="n">dr</span><span class="p">,</span> <span class="n">da</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">size</span> <span class="o">/</span> <span class="n">z</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">size</span> <span class="o">/</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span>
                <span class="n">box</span> <span class="o">=</span> <span class="n">Box</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">dr</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">a</span> <span class="o">-</span> <span class="n">da</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">da</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">dh</span><span class="o">.</span><span class="n">draw_rect</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">rect_type</span><span class="o">=</span><span class="s1">&#39;nodedot &#39;</span> <span class="o">+</span> <span class="n">active_node</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">nodedot_style</span><span class="p">)</span></div>


<div class="viewcode-block" id="DrawerCirc.draw_nodebox">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerCirc.draw_nodebox">[docs]</a>
    <span class="k">def</span> <span class="nf">draw_nodebox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">searched_by</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">da</span> <span class="o">=</span> <span class="n">box</span>
        <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">dh</span><span class="o">.</span><span class="n">clip_angles</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">da</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a1</span> <span class="o">&lt;</span> <span class="n">a2</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">dh</span><span class="o">.</span><span class="n">draw_nodebox</span><span class="p">(</span><span class="n">Box</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">a2</span> <span class="o">-</span> <span class="n">a1</span><span class="p">),</span>
                       <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_popup_props</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">searched_by</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span></div>


<div class="viewcode-block" id="DrawerCirc.draw_collapsed">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerCirc.draw_collapsed">[docs]</a>
    <span class="k">def</span> <span class="nf">draw_collapsed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collapsed_node</span><span class="p">,</span> <span class="n">active_children</span><span class="o">=</span><span class="n">TreeActive</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">selected_children</span><span class="o">=</span><span class="p">[]):</span>
        <span class="c1"># Draw line to farthest leaf under collapsed node</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">da</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline</span>

        <span class="n">p1</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">da</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">dr</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">da</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">dh</span><span class="o">.</span><span class="n">draw_line</span><span class="p">(</span><span class="n">dh</span><span class="o">.</span><span class="n">cartesian</span><span class="p">(</span><span class="n">p1</span><span class="p">),</span> <span class="n">dh</span><span class="o">.</span><span class="n">cartesian</span><span class="p">(</span><span class="n">p2</span><span class="p">),</span> <span class="s1">&#39;lengthline&#39;</span><span class="p">)</span></div>
</div>





<span class="c1"># The actual drawers.</span>

<div class="viewcode-block" id="DrawerRectFaces">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerRectFaces">[docs]</a>
<span class="k">class</span> <span class="nc">DrawerRectFaces</span><span class="p">(</span><span class="n">DrawerRect</span><span class="p">):</span>

<div class="viewcode-block" id="DrawerRectFaces.draw_node">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerRectFaces.draw_node">[docs]</a>
    <span class="k">def</span> <span class="nf">draw_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">bdx</span><span class="p">,</span> <span class="n">bdy</span><span class="p">,</span> <span class="n">bdy0</span><span class="p">,</span> <span class="n">bdy1</span><span class="p">,</span>
                  <span class="n">active_children</span><span class="o">=</span><span class="n">TreeActive</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">selected_children</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_size</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="c1"># Space available for branch-right Face position</span>
        <span class="n">dx_to_closest_child</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">is_leaf</span> <span class="k">else</span>
                               <span class="nb">min</span><span class="p">(</span><span class="n">dist</span><span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">))</span>
        <span class="n">zx</span><span class="p">,</span> <span class="n">zy</span><span class="p">,</span> <span class="n">za</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span>

        <span class="k">def</span> <span class="nf">it_fits</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">za</span> <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="s1">&#39;aligned&#39;</span> <span class="k">else</span> <span class="n">zx</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">box</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">z</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MIN_SIZE</span> <span class="ow">and</span>
                    <span class="n">dy</span> <span class="o">*</span> <span class="n">zy</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MIN_SIZE</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_viewport</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">pos</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">draw_face</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">n_row</span><span class="p">,</span> <span class="n">n_col</span><span class="p">,</span> <span class="n">dx_before</span><span class="p">,</span> <span class="n">dy_before</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">face</span><span class="o">.</span><span class="n">get_content</span><span class="p">():</span>
                <span class="n">box</span> <span class="o">=</span> <span class="n">face</span><span class="o">.</span><span class="n">compute_bounding_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
                            <span class="n">dx_to_closest_child</span><span class="p">,</span>
                            <span class="n">bdx</span><span class="p">,</span> <span class="n">bdy</span><span class="p">,</span> <span class="n">bdy0</span><span class="p">,</span> <span class="n">bdy1</span><span class="p">,</span>
                            <span class="n">pos</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">n_row</span><span class="p">,</span> <span class="n">n_col</span><span class="p">,</span>
                            <span class="n">dx_before</span><span class="p">,</span> <span class="n">dy_before</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">it_fits</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span> <span class="ow">and</span> <span class="n">face</span><span class="o">.</span><span class="n">fits</span><span class="p">())</span> <span class="ow">or</span> <span class="n">face</span><span class="o">.</span><span class="n">always_drawn</span><span class="p">:</span>
                    <span class="k">yield from</span> <span class="n">face</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">draw_faces_at_pos</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">is_collapsed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">is_leaf</span><span class="p">:</span>
                <span class="n">node_faces</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">collapsed_faces</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">node_faces</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">faces</span>

            <span class="n">faces</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">node_faces</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="p">{}))</span>
            <span class="n">n_col</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">faces</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">z</span> <span class="o">=</span> <span class="n">za</span> <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="s1">&#39;aligned&#39;</span> <span class="k">else</span> <span class="n">zx</span>

            <span class="c1"># Add SelectedFace for each search this node is a result of</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">selected_face_pos</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_children</span><span class="p">):</span>
                <span class="n">faces</span><span class="p">[</span><span class="n">n_col</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">selected_face</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">selected_children</span> <span class="p">]</span>
                <span class="n">n_col</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">active_face_pos</span><span class="p">:</span>
                <span class="n">active_faces</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="n">active_children</span><span class="o">.</span><span class="n">nodes</span>
                <span class="k">if</span> <span class="n">nodes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">active_faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">active_face</span><span class="p">(</span><span class="s2">&quot;active_nodes&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">nodes</span><span class="p">))</span>
                <span class="n">clades</span> <span class="o">=</span> <span class="n">active_children</span><span class="o">.</span><span class="n">clades</span>
                <span class="k">if</span> <span class="n">clades</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">active_faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">active_face</span><span class="p">(</span><span class="s2">&quot;active_clades&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">clades</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">active_faces</span><span class="p">:</span>
                    <span class="n">faces</span><span class="p">[</span><span class="n">n_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">active_faces</span>
                    <span class="n">n_col</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">dx_before</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">face_list</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">faces</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="s1">&#39;aligned&#39;</span>\
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">aligned_grid</span>\
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">NPANELS</span> <span class="o">&gt;</span> <span class="mi">1</span>\
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="o">&gt;</span> <span class="mi">0</span>\
                            <span class="ow">and</span> <span class="n">col</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Avoid changing-size error when zooming very quickly</span>
                    <span class="n">dxs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">aligned_grid_dxs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                    <span class="n">dx_before</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dxs</span> <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">col</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>

                <span class="n">dx_max</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">dy_before</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">n_row</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_list</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">face</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">face_list</span><span class="p">):</span>
                    <span class="n">face</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">node</span>

                    <span class="n">drawn_face</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">draw_face</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">n_row</span><span class="p">,</span> <span class="n">n_col</span><span class="p">,</span>
                            <span class="n">dx_before</span><span class="p">,</span> <span class="n">dy_before</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">drawn_face</span><span class="p">:</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">face</span><span class="o">.</span><span class="n">get_box</span><span class="p">()</span>
                        <span class="n">hz_padding</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">face</span><span class="o">.</span><span class="n">padding_x</span> <span class="o">/</span> <span class="n">z</span>
                        <span class="n">vt_padding</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">face</span><span class="o">.</span><span class="n">padding_y</span> <span class="o">/</span> <span class="n">zy</span>

                        <span class="c1"># NOTE: This is a hack to align nicely the headers in LayoutBarPlot.</span>
                        <span class="n">hfaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">_aligned_panel_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>  <span class="c1"># header faces</span>

                        <span class="k">if</span> <span class="n">col</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">hfaces</span><span class="p">:</span>
                            <span class="n">dx_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">hface</span><span class="o">.</span><span class="n">width</span> <span class="k">for</span> <span class="n">hface</span> <span class="ow">in</span> <span class="n">hfaces</span> <span class="k">if</span> <span class="n">hface</span><span class="o">.</span><span class="n">width</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">hz_padding</span> <span class="c1"># it&#39;s possible width is none</span>

                        <span class="n">dx_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dx_max</span><span class="p">,</span> <span class="p">(</span><span class="n">dx</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">hz_padding</span><span class="p">)</span>


                        <span class="n">dy_before</span> <span class="o">+=</span> <span class="n">dy</span> <span class="o">+</span> <span class="n">vt_padding</span>
                        <span class="k">yield from</span> <span class="n">drawn_face</span>

                <span class="c1"># Update dx_before</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="s1">&#39;aligned&#39;</span>\
                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">aligned_grid</span>\
                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">NPANELS</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">dx_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">aligned_grid_dxs</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Compute aligned grid</span>
                        <span class="n">dx_grid</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dx_grid</span><span class="p">,</span> <span class="n">dx_max</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">aligned_grid_dxs</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx_grid</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dx_before</span> <span class="o">+=</span> <span class="n">dx_grid</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dx_before</span> <span class="o">+=</span> <span class="n">dx_max</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">is_initialized</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">node</span><span class="o">.</span><span class="n">faces</span> <span class="o">=</span> <span class="n">make_faces</span><span class="p">()</span>
            <span class="n">node</span><span class="o">.</span><span class="n">collapsed_faces</span> <span class="o">=</span> <span class="n">make_faces</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">layout</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layouts</span><span class="p">:</span>
                <span class="n">layout</span><span class="o">.</span><span class="n">set_node_style</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="c1"># Render Faces in different panels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NPANELS</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">FACE_POSITIONS</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
                    <span class="k">yield from</span> <span class="n">draw_faces_at_pos</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
                <span class="c1"># Only run function to compute aligned grid</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">aligned_grid</span><span class="p">:</span>
                    <span class="n">deque</span><span class="p">(</span><span class="n">draw_faces_at_pos</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;aligned&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">draw_faces_at_pos</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;aligned&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">FACE_POSITIONS</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">draw_faces_at_pos</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span></div>


<div class="viewcode-block" id="DrawerRectFaces.draw_collapsed">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerRectFaces.draw_collapsed">[docs]</a>
    <span class="k">def</span> <span class="nf">draw_collapsed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collapsed_node</span><span class="p">,</span> <span class="n">active_children</span><span class="o">=</span><span class="n">TreeActive</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">selected_children</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fully_collapsed</span><span class="p">(</span><span class="n">collapsed_node</span><span class="p">):</span>
            <span class="n">bdx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">dist</span><span class="p">(</span><span class="n">collapsed_node</span><span class="p">)</span>
            <span class="n">bdx</span> <span class="o">=</span> <span class="n">dist</span><span class="p">(</span><span class="n">collapsed_node</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span>

        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_node</span><span class="p">(</span><span class="n">collapsed_node</span><span class="p">,</span>
                <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">bdx</span><span class="p">,</span> <span class="n">dy</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">active_children</span><span class="p">,</span> <span class="n">selected_children</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="DrawerCircFaces">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerCircFaces">[docs]</a>
<span class="k">class</span> <span class="nc">DrawerCircFaces</span><span class="p">(</span><span class="n">DrawerCirc</span><span class="p">):</span>

<div class="viewcode-block" id="DrawerCircFaces.draw_node">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerCircFaces.draw_node">[docs]</a>
    <span class="k">def</span> <span class="nf">draw_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">bdr</span><span class="p">,</span> <span class="n">bda</span><span class="p">,</span> <span class="n">bda0</span><span class="p">,</span> <span class="n">bda1</span><span class="p">,</span> <span class="n">active_children</span><span class="o">=</span><span class="n">TreeActive</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">selected_children</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_size</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="c1"># Space available for branch-right Face position</span>
        <span class="n">dr_to_closest_child</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dist</span><span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>\
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">is_leaf</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">is_collapsed</span><span class="p">)</span> <span class="k">else</span> <span class="n">dist</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># zx == zy</span>

        <span class="k">def</span> <span class="nf">it_fits</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">da</span> <span class="o">=</span> <span class="n">box</span>
            <span class="k">return</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span> \
                    <span class="ow">and</span> <span class="n">dr</span> <span class="o">*</span> <span class="n">z</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MIN_SIZE</span>\
                    <span class="ow">and</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">dr</span><span class="p">)</span> <span class="o">*</span> <span class="n">da</span> <span class="o">*</span> <span class="n">z</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MIN_SIZE</span>\
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_viewport</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">draw_face</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">n_row</span><span class="p">,</span> <span class="n">n_col</span><span class="p">,</span> <span class="n">dr_before</span><span class="p">,</span> <span class="n">da_before</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">face</span><span class="o">.</span><span class="n">get_content</span><span class="p">():</span>
                <span class="n">box</span> <span class="o">=</span> <span class="n">face</span><span class="o">.</span><span class="n">compute_bounding_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
                        <span class="n">dr_to_closest_child</span><span class="p">,</span>
                        <span class="n">bdr</span><span class="p">,</span> <span class="n">bda</span><span class="p">,</span> <span class="n">bda0</span><span class="p">,</span> <span class="n">bda1</span><span class="p">,</span>
                        <span class="n">pos</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">n_row</span><span class="p">,</span> <span class="n">n_col</span><span class="p">,</span>
                        <span class="n">dr_before</span><span class="p">,</span> <span class="n">da_before</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">it_fits</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span> <span class="ow">and</span> <span class="n">face</span><span class="o">.</span><span class="n">fits</span><span class="p">())</span> <span class="ow">or</span> <span class="n">face</span><span class="o">.</span><span class="n">always_drawn</span><span class="p">:</span>
                    <span class="k">yield from</span> <span class="n">face</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">draw_faces_at_pos</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">is_collapsed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">is_leaf</span><span class="p">:</span>
                <span class="n">node_faces</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">collapsed_faces</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">node_faces</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">faces</span>

            <span class="n">faces</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">node_faces</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="p">{}))</span>
            <span class="n">n_col</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">faces</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># Add SelectedFace for each search this node is a result of</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">selected_face_pos</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_children</span><span class="p">):</span>
                <span class="n">faces</span><span class="p">[</span><span class="n">n_col</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">selected_face</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">selected_children</span> <span class="p">]</span>
                <span class="n">n_col</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">active_face_pos</span><span class="p">:</span>
                <span class="n">active_faces</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="n">active_children</span><span class="o">.</span><span class="n">nodes</span>
                <span class="k">if</span> <span class="n">nodes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">active_faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">active_face</span><span class="p">(</span><span class="s2">&quot;active_nodes&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">nodes</span><span class="p">))</span>
                <span class="n">clades</span> <span class="o">=</span> <span class="n">active_children</span><span class="o">.</span><span class="n">clades</span>
                <span class="k">if</span> <span class="n">clades</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">active_faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">active_face</span><span class="p">(</span><span class="s2">&quot;active_clades&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">clades</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">active_faces</span><span class="p">:</span>
                    <span class="n">faces</span><span class="p">[</span><span class="n">n_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">active_faces</span>
                    <span class="n">n_col</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Avoid drawing faces very close to center</span>
            <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;branch-&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">:</span>
                <span class="n">n_col</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">dr_before</span> <span class="o">=</span> <span class="mf">.7</span> <span class="o">*</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">n_col</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dr_before</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">face_list</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">faces</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="s1">&#39;aligned&#39;</span>\
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">aligned_grid</span>\
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">NPANELS</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Avoid changing-size error when zooming very quickly</span>
                    <span class="n">drs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">aligned_grid_dxs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                    <span class="n">dr_before</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">drs</span> <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">col</span><span class="p">)</span>
                <span class="n">dr_max</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">da_before</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">n_row</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_list</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">face</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">face_list</span><span class="p">):</span>
                    <span class="n">face</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">node</span>
                    <span class="n">drawn_face</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">draw_face</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">n_row</span><span class="p">,</span> <span class="n">n_col</span><span class="p">,</span>
                            <span class="n">dr_before</span><span class="p">,</span> <span class="n">da_before</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">drawn_face</span><span class="p">:</span>
                        <span class="n">r</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">da</span> <span class="o">=</span> <span class="n">face</span><span class="o">.</span><span class="n">get_box</span><span class="p">()</span>
                        <span class="n">hz_padding</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">face</span><span class="o">.</span><span class="n">padding_x</span> <span class="o">/</span> <span class="n">z</span>
                        <span class="n">vt_padding</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">face</span><span class="o">.</span><span class="n">padding_y</span> <span class="o">/</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="ow">or</span> <span class="mf">1e-10</span><span class="p">))</span>
                        <span class="n">dr_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dr_max</span><span class="p">,</span> <span class="n">dr</span> <span class="o">+</span> <span class="n">hz_padding</span><span class="p">)</span>
                        <span class="n">da_before</span> <span class="o">=</span> <span class="n">da</span> <span class="o">+</span> <span class="n">vt_padding</span>
                        <span class="k">yield from</span> <span class="n">drawn_face</span>

                <span class="c1"># Update dr_before</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="s1">&#39;aligned&#39;</span>\
                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">aligned_grid</span>\
                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">NPANELS</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">dr_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">aligned_grid_dxs</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Compute aligned grid</span>
                        <span class="n">dr_grid</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dr_grid</span><span class="p">,</span> <span class="n">dr_max</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">aligned_grid_dxs</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">dr_grid</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dr_before</span> <span class="o">+=</span> <span class="n">dr_grid</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dr_before</span> <span class="o">+=</span> <span class="n">dr_max</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">is_initialized</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">layout</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layouts</span><span class="p">:</span>
                <span class="n">layout</span><span class="o">.</span><span class="n">set_node_style</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="c1"># Render Faces in different panels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NPANELS</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">FACE_POSITIONS</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
                    <span class="k">yield from</span> <span class="n">draw_faces_at_pos</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
                <span class="c1"># Only run function to compute aligned grid</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_style</span><span class="o">.</span><span class="n">aligned_grid</span><span class="p">:</span>
                    <span class="n">deque</span><span class="p">(</span><span class="n">draw_faces_at_pos</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;aligned&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">draw_faces_at_pos</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;aligned&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">FACE_POSITIONS</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">draw_faces_at_pos</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span></div>


<div class="viewcode-block" id="DrawerCircFaces.draw_collapsed">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerCircFaces.draw_collapsed">[docs]</a>
    <span class="k">def</span> <span class="nf">draw_collapsed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collapsed_node</span><span class="p">,</span> <span class="n">active_children</span><span class="o">=</span><span class="n">TreeActive</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">selected_children</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">da</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fully_collapsed</span><span class="p">(</span><span class="n">collapsed_node</span><span class="p">):</span>
            <span class="n">bdr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">-</span> <span class="n">dist</span><span class="p">(</span><span class="n">collapsed_node</span><span class="p">)</span>
            <span class="n">bdr</span> <span class="o">=</span> <span class="n">dist</span><span class="p">(</span><span class="n">collapsed_node</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span>

        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_node</span><span class="p">(</span><span class="n">collapsed_node</span><span class="p">,</span>
                <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">a</span><span class="p">),</span> <span class="n">bdr</span><span class="p">,</span> <span class="n">da</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="n">active_children</span><span class="p">,</span> <span class="n">selected_children</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="DrawerAlignRectFaces">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerAlignRectFaces">[docs]</a>
<span class="k">class</span> <span class="nc">DrawerAlignRectFaces</span><span class="p">(</span><span class="n">DrawerRectFaces</span><span class="p">):</span>
    <span class="n">NPANELS</span> <span class="o">=</span> <span class="mi">4</span></div>



<div class="viewcode-block" id="DrawerAlignCircFaces">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.DrawerAlignCircFaces">[docs]</a>
<span class="k">class</span> <span class="nc">DrawerAlignCircFaces</span><span class="p">(</span><span class="n">DrawerCircFaces</span><span class="p">):</span>
    <span class="n">NPANELS</span> <span class="o">=</span> <span class="mi">2</span></div>



<div class="viewcode-block" id="get_drawers">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.get_drawers">[docs]</a>
<span class="k">def</span> <span class="nf">get_drawers</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span> <span class="n">DrawerRect</span><span class="p">,</span> <span class="n">DrawerCirc</span><span class="p">,</span>
            <span class="n">DrawerRectFaces</span><span class="p">,</span> <span class="n">DrawerCircFaces</span><span class="p">,</span>
            <span class="n">DrawerAlignRectFaces</span><span class="p">,</span> <span class="n">DrawerAlignCircFaces</span><span class="p">,</span> <span class="p">]</span></div>



<span class="c1"># Box-related functions.</span>

<div class="viewcode-block" id="make_box">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.make_box">[docs]</a>
<span class="k">def</span> <span class="nf">make_box</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">point</span>
    <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">size</span>
    <span class="k">return</span> <span class="n">Box</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_rect">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.get_rect">[docs]</a>
<span class="k">def</span> <span class="nf">get_rect</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
    <span class="s2">&quot;Return the rectangle that contains the given graphic element&quot;</span>
    <span class="n">eid</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># elements are tuples with element-id in the 1st place</span>

    <span class="k">if</span> <span class="n">eid</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nodebox&#39;</span><span class="p">,</span> <span class="s1">&#39;rect&#39;</span><span class="p">,</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;triangle&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;img&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">eid</span> <span class="o">==</span> <span class="s1">&#39;outline&#39;</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Box</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">eid</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;pixi-&#39;</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Box</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">eid</span> <span class="o">==</span> <span class="s1">&#39;rhombus&#39;</span><span class="p">:</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span>
        <span class="k">return</span>  <span class="n">Box</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">eid</span> <span class="o">==</span> <span class="s1">&#39;polygon&#39;</span><span class="p">:</span>
        <span class="n">min_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">max_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">min_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">Box</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">eid</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="s1">&#39;arc&#39;</span><span class="p">]:</span>  <span class="c1"># not a great approximation for an arc...</span>
        <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">element</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Box</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">eid</span> <span class="o">==</span> <span class="s1">&#39;circle&#39;</span><span class="p">:</span>
        <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">r</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">element</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">zx</span><span class="p">,</span> <span class="n">zy</span> <span class="o">=</span> <span class="n">zoom</span>
        <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span> <span class="o">=</span> <span class="n">r</span> <span class="o">/</span> <span class="n">zx</span><span class="p">,</span> <span class="n">r</span> <span class="o">/</span> <span class="n">zy</span>
        <span class="k">return</span> <span class="n">Box</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">rx</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">ry</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">rx</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ry</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">eid</span> <span class="o">==</span> <span class="s1">&#39;ellipse&#39;</span><span class="p">:</span>
        <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">zx</span><span class="p">,</span> <span class="n">zy</span> <span class="o">=</span> <span class="n">zoom</span>
        <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span> <span class="o">=</span> <span class="n">rx</span> <span class="o">/</span> <span class="n">zx</span><span class="p">,</span> <span class="n">ry</span> <span class="o">/</span> <span class="n">zy</span>
        <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">Box</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">rx</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">ry</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">rx</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ry</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">eid</span> <span class="o">==</span> <span class="s1">&#39;slice&#39;</span><span class="p">:</span>
        <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">r</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">zx</span><span class="p">,</span> <span class="n">zy</span> <span class="o">=</span> <span class="n">zoom</span>
        <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span> <span class="o">=</span> <span class="n">r</span> <span class="o">/</span> <span class="n">zx</span><span class="p">,</span> <span class="n">r</span> <span class="o">/</span> <span class="n">zy</span>
        <span class="k">return</span> <span class="n">Box</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">rx</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">ry</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">rx</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ry</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unrecognized element: </span><span class="si">{</span><span class="n">element</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_asec">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.get_asec">[docs]</a>
<span class="k">def</span> <span class="nf">get_asec</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
    <span class="s2">&quot;Return the annular sector that contains the given graphic element&quot;</span>
    <span class="n">eid</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># elements are tuples with element-id in the 1st place</span>

    <span class="k">if</span> <span class="n">eid</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nodebox&#39;</span><span class="p">,</span> <span class="s1">&#39;rect&#39;</span><span class="p">,</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;triangle&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;img&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">eid</span> <span class="o">==</span> <span class="s1">&#39;outline&#39;</span><span class="p">:</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">da</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Box</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">da</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">eid</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;pixi-&#39;</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Box</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">eid</span> <span class="o">==</span> <span class="s1">&#39;rhombus&#39;</span><span class="p">:</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dr</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span>
        <span class="n">da</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span>
        <span class="k">return</span> <span class="n">Box</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">dr</span> <span class="p">,</span> <span class="n">da</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">eid</span> <span class="o">==</span> <span class="s1">&#39;polygon&#39;</span><span class="p">:</span>
        <span class="n">min_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">max_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">min_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">Box</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">eid</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="s1">&#39;arc&#39;</span><span class="p">]:</span>
        <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">element</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">Box</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">dh</span><span class="o">.</span><span class="n">circumasec</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">eid</span> <span class="o">==</span> <span class="s1">&#39;circle&#39;</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">r</span> <span class="o">=</span> <span class="n">dh</span><span class="o">.</span><span class="n">cartesian</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">element</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">z</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">Box</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">r</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dh</span><span class="o">.</span><span class="n">circumasec</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">eid</span> <span class="o">==</span> <span class="s1">&#39;ellipse&#39;</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">dh</span><span class="o">.</span><span class="n">cartesian</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">z</span><span class="p">,</span> <span class="n">element</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">z</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">Box</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">rx</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">ry</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">rx</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ry</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dh</span><span class="o">.</span><span class="n">circumasec</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">eid</span> <span class="o">==</span> <span class="s1">&#39;slice&#39;</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">r</span> <span class="o">=</span> <span class="n">dh</span><span class="o">.</span><span class="n">cartesian</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">z</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">Box</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">r</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dh</span><span class="o">.</span><span class="n">circumasec</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unrecognized element: </span><span class="si">{</span><span class="n">element</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="drawn_size">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.drawn_size">[docs]</a>
<span class="k">def</span> <span class="nf">drawn_size</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">get_box</span><span class="p">,</span> <span class="n">min_x</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="s2">&quot;Return the size of a box containing all the elements&quot;</span>
    <span class="c1"># The type of size will depend on the kind of boxes that are returned by</span>
    <span class="c1"># get_box() for the elements. It is width and height for boxes that are</span>
    <span class="c1"># rectangles, and dr and da for boxes that are annular sectors.</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">elements</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Size</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">get_box</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">dx</span>
    <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">dy</span>

    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">get_box</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_max</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">)</span>
        <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_max</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">dy</span><span class="p">)</span>

    <span class="c1"># Constrains x_min</span>
    <span class="c1"># Necessary for collapsed nodes with branch-top/bottom faces</span>
    <span class="k">if</span> <span class="n">min_x</span><span class="p">:</span>
        <span class="n">x_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">min_x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Size</span><span class="p">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">-</span> <span class="n">y_min</span><span class="p">)</span></div>



<div class="viewcode-block" id="dist">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.dist">[docs]</a>
<span class="k">def</span> <span class="nf">dist</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the distance of a node, with default values if not set.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dist&#39;</span><span class="p">,</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">up</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span><span class="p">))</span></div>



<div class="viewcode-block" id="stack">
<a class="viewcode-back" href="../../../../reference/reference_smartview.html#ete4.smartview.renderer.drawer.stack">[docs]</a>
<span class="k">def</span> <span class="nf">stack</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the box resulting from stacking the given boxes.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">box1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">box2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx1</span><span class="p">,</span> <span class="n">dy1</span> <span class="o">=</span> <span class="n">box1</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dx2</span><span class="p">,</span> <span class="n">dy2</span> <span class="o">=</span> <span class="n">box2</span>
        <span class="k">return</span> <span class="n">Box</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">dx1</span><span class="p">,</span> <span class="n">dx2</span><span class="p">),</span> <span class="n">dy1</span> <span class="o">+</span> <span class="n">dy2</span><span class="p">)</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">ETE Toolkit</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/index.html">Reference Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../faqs.html">Frequently Asked Questions</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2008 - 2023, The ETE Toolkit Team.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>